<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="haitian的博客">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="haitian的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="haitian的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/3/"/>





  <title>haitian的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">haitian的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">为了更好的生活而奋斗!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/10/17/the-default-rsync-bug-in-redhat5-4-5-5-5-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/17/the-default-rsync-bug-in-redhat5-4-5-5-5-6/" itemprop="url">在redhat5.4/5.5/5.6中默认的rsync出现的bug</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-17T11:23:12+08:00">
                2011-10-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>测试环境为：</p>
<p>Client(192.168.1.3)——————–àdaemon(192.168.1.2)</p>
<p>———————–配置过的先略过，直接看测试过程—————-</p>
<p>服务端配置：</p>
<p>/etc/rsyncd/Rsyncd.conf配置</p>
<p># Minimal configuration file for rsync daemon</p>
<p># See rsync(1) and rsyncd.conf(5) man pages for help</p>
<p># This line is required by the /etc/init.d/rsyncd script</p>
<p>pid file = /var/run/rsyncd.pid  </p>
<p>port = 873</p>
<p>address = 192.168.1.2</p>
<p>uid = test</p>
<p>gid = test</p>
<p>auth users = test</p>
<p>secrets file = /etc/rsyncd/rsyncd.secrets </p>
<p>#incoming chmod = u+rwx,g+rwx,o+rx</p>
<p>use chroot = yes </p>
<p>read only = no </p>
<p>#limit access to private LANs</p>
<p>hosts allow=192.168.1.3/255.255.255.255</p>
<p>hosts deny=*</p>
<p>max connections = 500</p>
<p>#This will give you a separate log file</p>
<p>log file = /var/log/rsync.log</p>
<p>#This will log every file transferred - up to 85,000+ per user, per sync</p>
<p>#transfer logging = yes</p>
<p>log format = %t %a %m %f %b</p>
<p>syslog facility = local3</p>
<p>timeout = 300</p>
<p>[app]  </p>
<p>path = /app/test（目标目录）</p>
<p>list=yes</p>
<p>#ignore errors</p>
<p>/etc/rsyncd/rsyncd.secrets  配置</p>
<p>test:123456（密码）</p>
<p>启动服务端/usr/bin/rsync –daemon –config=/etc/rsyncd/rsyncd.conf</p>
<p>客户端配置</p>
<p>客户端：</p>
<p>/etc/rsync_client.pass</p>
<p>123456（密码）</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /boot <a href="mailto:audit@192.168.1.2::app" target="_blank" rel="noopener">test@192.168.1.2::app</a></p>
<p>————————————————————-配置完成————————————————-</p>
<p>测试过程：</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /boot <a href="mailto:audit@192.168.1.2::app" target="_blank" rel="noopener">test@192.168.1.2::app</a></p>
<p>结果正确，没有出现问题</p>
<p>再进行</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /home <a href="mailto:audit@192.168.1.2::app" target="_blank" rel="noopener">test@192.168.1.2::app</a></p>
<p>结果也正确，没有出现问题</p>
<p>再进行</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /etc <a href="mailto:audit@192.168.1.2::app" target="_blank" rel="noopener">test@192.168.1.2::app</a></p>
<p>这回报错了</p>
<p>出现如下错误：</p>
<p>unexpected tag 3 [sender]</p>
<p>rsync error: error in rsync protocol data stream (code 12) at io.c(828)</p>
<p>[sender=2.6.8]</p>
<p>而此时服务端的错误日志如下：</p>
<p>2008/11/12 00:25:42 [12657] rsync: read error: Connection reset by peer (104)</p>
<p>2008/11/12 00:25:42 [12657] rsync error: error in rsync protocol data stream</p>
<p>(code 12) at io.c(614) [receiver=2.6.8]</p>
<p>2008/11/12 00:25:42 [12657] rsync: connection unexpectedly closed (486 bytes</p>
<p>received so far) [generator]</p>
<p>2008/11/12 00:25:42 [12657] rsync error: error in rsync protocol data stream</p>
<p>(code 12) at io.c(463) [generator=2.6.8]</p>
<p>再同步一次就成功。</p>
<p>把服务端下已经同步的文件删除，再不尝试一次</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /etc <a href="mailto:audit@192.168.1.2::app" target="_blank" rel="noopener">test@192.168.1.2::app</a></p>
<p>还是报错。文件只同步了部分文件，发现在同步的源文件中如果文件数太多，或者子目录太多，就经常会出现这一种情况。</p>
<p>根据多次查找发现在2.6.8上会出现这一个问题，在2.6.9上已经解决，经查看在redhat5.4，5.5和5.6的发行版中都是使用rsync-2.6.8的版本。</p>
<p><a href="http://rsync.samba.org/ftp/rsync/src/rsync-2.6.9-NEWS" target="_blank" rel="noopener">http://rsync.samba.org/ftp/rsync/src/rsync-2.6.9-NEWS</a>在官方上看到了更新日志</p>
<p>- Fixed a bug where a deferred info/error/log message could get sent directly to the sender instead of being handled by rwrite() in the generator. This fixes an “unexpected tag 3” fatal error, and should also fix a potential problem where a deferred info/error message from the receiver might bypass the log file and get sent only to the client process. (These problems could only affect an rsync daemon that was receiving files.)</p>
<p>Redhat上的bug报告文件如下：</p>
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=471182" target="_blank" rel="noopener">https://bugzilla.redhat.com/show_bug.cgi?id=471182</a></p>
<p>解决方法：</p>
<p>升级rsync到2.6.9以上，只需要升级服务器端就可以了！因为这一个bug只会影响服务端的接收。</p>
<p>在redhat5.7中已经默认修复了这一个问题。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/10/12/memcached-limits-key-and-value/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/12/memcached-limits-key-and-value/" itemprop="url">memcached对key和value的限制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-12T14:46:12+08:00">
                2011-10-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>memcached的简单限制就是键（key）和item的限制。最大键长为250个字符。可以接受的储存数据不能超过1MB，因为这是典型slab 的最大值。这里我们可以突破对key长度的限制。<br>问题解决：<br>修改memcached源文件。在memcached.h中定义key的长度，其代码为：  </p>
<p>#define KEY_MAX_LENGTH 250  </p>
<p>更换为所需要的长度，比如：1024</p>
<p>#define KEY_MAX_LENGTH 1024  </p>
<p>而value的默认限制为1M</p>
<p>-I            Override the size of each slab page. Adjusts max item size<br>              (default: 1mb, min: 1k, max: 128m)</p>
<p>要增加的话，启动时添加-I 10m参数就可以。</p>
<p>会有一个警告：</p>
<p>WARNING: Setting item max size above 1MB is not recommended!<br> Raising this limit increases the minimum memory requirements<br> and will decrease your memory efficiency.</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/10/09/rsync-configuration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/09/rsync-configuration/" itemprop="url">rsync配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-09T17:15:10+08:00">
                2011-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>/etc/rsyncd/Rsyncd.conf配置</p>
<p># Minimal configuration file for rsync daemon</p>
<p># See rsync(1) and rsyncd.conf(5) man pages for help</p>
<p># This line is required by the /etc/init.d/rsyncd script</p>
<p>pid file = /var/run/rsyncd.pid  </p>
<p>port = 873</p>
<p>address = 192.168.100.3</p>
<p>uid = audit</p>
<p>gid = audit</p>
<p>auth users = audit</p>
<p>secrets file = /etc/rsyncd/rsyncd.secrets </p>
<p>#incoming chmod = u+rwx,g+rwx,o+rx</p>
<p>use chroot = yes </p>
<p>read only = no </p>
<p>#limit access to private LANs</p>
<p>hosts allow=192.168.96.0/255.255.255.0</p>
<p>hosts deny=*</p>
<p>max connections = 500</p>
<p>#This will give you a separate log file</p>
<p>log file = /var/log/rsync.log</p>
<p>#This will log every file transferred - up to 85,000+ per user, per sync</p>
<p>#transfer logging = yes</p>
<p>log format = %t %a %m %f %b</p>
<p>syslog facility = local3</p>
<p>timeout = 300</p>
<p>[app]  </p>
<p>path = /app/audit（目标目录）</p>
<p>list=yes</p>
<p>#ignore errors</p>
<p>/etc/rsyncd/rsyncd.secrets  配置</p>
<p>audit:skymobi（密码）</p>
<p>启动服务端/usr/bin/rsync –daemon –config=/etc/rsyncd/rsyncd.conf</p>
<p>客户端：</p>
<p>/etc/rsync_client.pass</p>
<p>Skymobi（密码）</p>
<p>rsync -av  –password-file=/etc/rsync_client.pass /usr/local/httpd/htdocs/sms/vsms/sessions/ <a href="mailto:audit@192.168.100.3::app" target="_blank" rel="noopener">audit@192.168.100.3::app</a></p>
<p>如果害怕把带宽跑满就加上限速功能</p>
<p>–bwlimit=KBPS          limit I/O bandwidth; KBytes per second</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/10/09/the-blktrace-uses-a-simplified-analysis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/10/09/the-blktrace-uses-a-simplified-analysis/" itemprop="url">blktrace使用简析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-10-09T17:01:33+08:00">
                2011-10-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>blktrace是一个针对Linux内核中块设备I/O层的跟踪工具，是由Linux内核块设备层的维护者开发的，目前已经集成到内核2.6.17及其之后的内核版本中。通过使用这个工具，使用者可以获取I/O请求队列的各种详细的情况，包括进行读写的进程名称、进程号、执行时间、读写的物理块号、块大小等等，是一个Linux下分析I/O相关内容的很好的工具，在使用时基本上只会占用系统2%的资源，下面主要说一下本人在blktrace上手时的一些心得。<br>    因为blktrace已经集成到2.6.17及其之后的版本中，所以一般比较新的系统版本都无需下载，本人使用的是Fedora 8，内核版本为2.6.23，但是此工具并未安装，所以需要在使用前安装blktrace：<br>yum install blktrace<br>通过以上命令安装完成后，需要手工设定debug文件系统，命令如下：<br>mount -t debugfs debugfs /sys/kernel/debug<br>这样blktrace就可以成功运行了。<br>    blktrace的运行命令可以包括许多的详细配置，一一列举起来实在太多，而且没有必要，下面通过几个例子来直观的说明常用的几个监测功能：<br>运行命令1：<br>blktrace -d /dev/sda -o - |blkparse -i -<br>此命令是将blktrace的结果输出到屏幕，然后blkparse将屏幕中的blktrace的结果作为分析的输入，最后将分析的结果同样输出到屏幕。这里需要指出的是，blkparse是基于blktrace的分析工具，因为blktrace本身并不具有分析功能，它只是进行监测，其余的工作都是由blkparse来进行的。<br>运行命令2：<br>blktrace -d /dev/sda |blkparse -i -<br>此命令是将blktrace的结果输出到本地文件夹，文件名为sda.blktrace.0和sda.blktrace.1，这里之所以有两个文件是因为运行机器有两个CPU的缘故，blktrace根据CPU的个数来生成文件，对应每个CPU都有一个相应的监测数据文件。<br>运行命令3：<br>blktrace -d /dev/sda -o trace |blkparse -i -<br>此命令是将blktrace的结果输出到已经事先指定好的文件trace中，注意这个trace文件必须在本地文件夹中存在，无需带有任何后缀</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/30/redis-orders-the-summary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/30/redis-orders-the-summary/" itemprop="url">Redis 命令小结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-30T10:33:45+08:00">
                2011-09-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://redis.io/commands" target="_blank" rel="noopener">http://redis.io/commands</a></p>
<p><strong>连接控制</strong></p>
<p>QUIT 关闭连接</p>
<p>AUTH (仅限启用时)简单的密码验证</p>
<p><strong>适合全体类型的命令</strong></p>
<p>EXISTS key 判断一个键是否存在;存在返回 1;否则返回0;</p>
<p>DEL key 删除某个key,或是一系列key;DEL key1 key2 key3 key4</p>
<p>TYPE key 返回某个key元素的数据类型 ( none:不存在,string:字符,list,set,zset,hash)</p>
<p>KEYS pattern 返回匹配的key列表 (KEYS foo<em>:查找foo开头的keys),KEYS </em> 就列出所有的key了，当然，复杂度O(n)</p>
<p>RANDOMKEY 随机获得一个已经存在的key，如果当前数据库为空，则返回空字符串</p>
<p>RENAME oldname newname更改key的名字，新键如果存在将被覆盖</p>
<p>RENAMENX oldname newname 更改key的名字，如果名字存在则更改失败</p>
<p>DBSIZE返回当前数据库的key的总数</p>
<p>EXPIRE设置某个key的过期时间（秒）,(EXPIRE bruce 1000：设置bruce这个key1000秒后系统自动删除)注意：如果在还没有过期的时候，对值进行了改变，那么那个值会被清除。</p>
<p>TTL查找某个key还有多长时间过期,返回时间秒</p>
<p>SELECT index 选择数据库</p>
<p>MOVE key dbindex 将指定键从当前数据库移到目标数据库 dbindex。成功返回 1;否则返回0（源数据库不存在key或目标数据库已存在同名key）;</p>
<p>FLUSHDB 清空当前数据库中的所有键</p>
<p>FLUSHALL 清空所有数据库中的所有键</p>
<p><strong>处理字符串的命令</strong></p>
<p>SET key value 给一个键设置字符串值。SET keyname datalength data (SET bruce 10 paitoubing:保存key为burce,字符串长度为10的一个字符串paitoubing到数据库)，data最大不可超过1G。</p>
<p>GET key获取某个key 的value值。如key不存在，则返回字符串“nil”；如key的值不为字符串类型，则返回一个错误。</p>
<p>GETSET key value可以理解成获得的key的值然后SET这个值，更加方便的操作 (SET bruce 10 paitoubing,这个时候需要修改bruce变成1234567890并获取这个以前的数据paitoubing,GETSET bruce 10 1234567890)</p>
<p>MGET key1 key2 … keyN 一次性返回多个键的值</p>
<p>SETNX key value SETNX与SET的区别是SET可以创建与更新key的value，而SETNX是如果key不存在，则创建key与value数据</p>
<p>MSET key1 value1 key2 value2 … keyN valueN 在一次原子操作下一次性设置多个键和值</p>
<p>MSETNX key1 value1 key2 value2 … keyN valueN 在一次原子操作下一次性设置多个键和值（目标键不存在情况下，如果有一个以上的key已存在，则失败）</p>
<p>INCR key 自增键值</p>
<p>INCRBY key integer 令键值自增指定数值</p>
<p>DECR key 自减键值</p>
<p>DECRBY key integer 令键值自减指定数值</p>
<p><strong>处理 lists 的命令</strong></p>
<p>RPUSH key value 从 List 尾部添加一个元素（如序列不存在，则先创建，如已存在同名Key而非序列，则返回错误）</p>
<p>LPUSH key value 从 List 头部添加一个元素</p>
<p>LLEN key 返回一个 List 的长度</p>
<p>LRANGE key start end从自定的范围内返回序列的元素 (LRANGE testlist 0 2;返回序列testlist前0 1 2元素)</p>
<p>LTRIM key start end修剪某个范围之外的数据 (LTRIM testlist 0 2;保留0 1 2元素，其余的删除)</p>
<p>LINDEX key index返回某个位置的序列值(LINDEX testlist 0;返回序列testlist位置为0的元素)</p>
<p>LSET key index value更新某个位置元素的值</p>
<p>LREM key count value 从 List 的头部（count正数）或尾部（count负数）删除一定数量（count）匹配value的元素，返回删除的元素数量。</p>
<p>LPOP key 弹出 List 的第一个元素</p>
<p>RPOP key 弹出 List 的最后一个元素</p>
<p>RPOPLPUSH srckey dstkey 弹出 _srckey_ 中最后一个元素并将其压入 _dstkey_头部，key不存在或序列为空则返回“nil”</p>
<p><strong>处理集合(sets)的命令（有索引无序序列）</strong></p>
<p>SADD key member增加元素到SETS序列,如果元素（membe）不存在则添加成功 1，否则失败 0;(SADD testlist 3 \n one)</p>
<p>SREM key member 删除SETS序列的某个元素，如果元素不存在则失败0，否则成功 1(SREM testlist 3 \N one)</p>
<p>SPOP key 从集合中随机弹出一个成员</p>
<p>SMOVE srckey dstkey member 把一个SETS序列的某个元素 移动到 另外一个SETS序列 (SMOVE testlist test 3\n two;从序列testlist移动元素two到 test中，testlist中将不存在two元素)</p>
<p>SCARD key 统计某个SETS的序列的元素数量</p>
<p>SISMEMBER key member 获知指定成员是否存在于集合中</p>
<p>SINTER key1 key2 … keyN 返回 key1, key2, …, keyN 中的交集</p>
<p>SINTERSTORE dstkey key1 key2 … keyN 将 key1, key2, …, keyN 中的交集存入 dstkey</p>
<p>SUNION key1 key2 … keyN 返回 key1, key2, …, keyN 的并集</p>
<p>SUNIONSTORE dstkey key1 key2 … keyN 将 key1, key2, …, keyN 的并集存入 dstkey</p>
<p>SDIFF key1 key2 … keyN 依据 key2, …, keyN 求 key1 的差集。官方例子：</p>
<p>key1 = x,a,b,c</p>
<p>key2 = c</p>
<p>key3 = a,d</p>
<p>SDIFF key1,key2,key3 =&gt; x,b</p>
<p>SDIFFSTORE dstkey key1 key2 … keyN 依据 key2, …, keyN 求 key1 的差集并存入 dstkey</p>
<p>SMEMBERS key 返回某个序列的所有元素</p>
<p>SRANDMEMBER key 随机返回某个序列的元素</p>
<p><strong>处理有序集合(sorted sets)的命令 (zsets)</strong></p>
<p>ZADD key score member 添加指定成员到有序集合中，如果目标存在则更新score（分值，排序用）</p>
<p>ZREM key member 从有序集合删除指定成员</p>
<p>ZINCRBY key increment member 如果成员存在则将其增加_increment_，否则将设置一个score为_increment_的成员</p>
<p>ZRANGE key start end 返回升序排序后的指定范围的成员</p>
<p>ZREVRANGE key start end 返回降序排序后的指定范围的成员</p>
<p>ZRANGEBYSCORE key min max 返回所有符合score &gt;= min和score &lt;= max的成员 ZCARD key 返回有序集合的元素数量 ZSCORE key element 返回指定成员的SCORE值 ZREMRANGEBYSCORE key min max 删除符合 score &gt;= min 和 score &lt;= max 条件的所有成员</p>
<p><strong>排序（List, Set, Sorted Set）</strong></p>
<p>SORT key BY pattern LIMIT start end GET pattern ASC|DESC ALPHA 按照指定模式排序集合或List</p>
<p>SORT mylist</p>
<p>默认升序 ASC</p>
<p>SORT mylist DESC</p>
<p>SORT mylist LIMIT 0 10</p>
<p>从序号0开始，取10条</p>
<p>SORT mylist LIMIT 0 10 ALPHA DESC</p>
<p>按首字符排序</p>
<p>SORT mylist BY weight_*</p>
<p>SORT mylist BY weight_<em> GET object_</em></p>
<p>SORT mylist BY weight_<em> GET object_</em> GET #</p>
<p>SORT mylist BY weight_* STORE resultkey</p>
<p>将返回的结果存放于resultkey序列（List）</p>
<p><strong>持久控制</strong></p>
<p>SAVE 同步保存数据到磁盘</p>
<p>BGSAVE 异步保存数据到磁盘</p>
<p>LASTSAVE 返回上次成功保存到磁盘的Unix时间戳</p>
<p>SHUTDOWN 同步保存到服务器并关闭 Redis 服务器（SAVE+QUIT）</p>
<p>BGREWRITEAOF 当日志文件过长时重写日志文件</p>
<p><strong>远程控制命令</strong></p>
<p>INFO 提供服务器的信息和统计信息</p>
<p>MONITOR 实时输出所有收到的请求</p>
<p>SLAVEOF 修改复制选项</p>
<p><strong>redis目前提供四种数据类型：string,list,set及zset(sorted set)。</strong></p>
<p>* string是最简单的类型，你可以理解成与Memcached一模一个的类型，一个key对应一个value，其上支持的操作与Memcached的操 作类似。但它的功能更丰富。</p>
<p>* list是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等。操作中key理解为链表的名字。</p>
<p>* set是集合，和我们数学中的集合概念相似，对集合的操作有添加删除元素，有对多个集合求交并差等操作。操作中key理解为集合的名字。</p>
<p>* zset是set的一个升级版本，他在set的基础上增加了一个顺序属性，这一属性在添加修改元素的时候可以指定，每次指定后，zset会自动重新按新的 值调整顺序。可以理解了有两列的mysql表，一列存value，一列存顺序。操作中key理解为zset的名字。</p>
<p>协议</p>
<p>redis目前只有基于TCP的文本协议，与memcache类似，有一些改进。</p>
<p>客户端通常发送</p>
<p>命令 参数… 值字节数\r\n</p>
<p>值\r\n</p>
<p>服务端的返回，根据第一个字节，可以判断：</p>
<p>- 错误信息</p>
<p>+ 普通文本信息</p>
<p>$ 变长字节数，$6表示CRLF之后有6个字节的字符</p>
<p>: 返回一个整数</p>
<p>* 返回组数，即*6表示CRLF之后将返回6组变长字符</p>
<p>注意事项：</p>
<p>Key不可包含空格或者回车符</p>
<p>Key不要过长或过短，应使其有意义，如”comment:1234:reply.to”</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/20/an-introduction-to-mail-relay-rules-in-sendmail-8-9-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/20/an-introduction-to-mail-relay-rules-in-sendmail-8-9-3/" itemprop="url">Sendmail 8.9.3中的Mail Relay规则简介</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-20T09:22:11+08:00">
                2011-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>一.什么是第三方的Mail Relay?    
</strong>当一台邮件服务器处理一封邮件时，该封邮件的发送者(the sender)和接收者(the recipient)都不是本地用户（local user),即发送者和接收者都处于本地域之外，该邮件服务器对于这封邮件的传送完全属于不相关的第三方，因此Mail Relay被sedmail默认禁止了。这阻止了Spammer利用你的服务器发送垃圾邮件。<br><strong>二.为什么你要停止第三方的Mail Relay?    
</strong>如果你的邮件服务器不能有效地控制第三方的mail relay，你应该立刻着手解决这个问题，不要等待spammer 来攻击你的邮件主机，主要是因为：<br>a.大量的垃圾邮件（junk email）可能会使你的邮件系统崩溃。它们占用你的磁盘空间，CPU资源，还可能引发Dos类型攻击（denial of  service attack).<br>b.你的组织可能被列入黑名单（backlist)。由于大量垃圾邮件从你的主机发出，其它一些组织或公司可能会不做任何更深的调查就更改设置阻止了从你的主机来的任何邮件，这也将同时阻止从你的站点发到它们的所有正常的商业性邮件,损失不可估量.<br>c.意识到这种攻击将会发生在你身上。不要因为它没有发生就意味着你是安全的。他们每天正用一些自动扫描的工具去扫描网络而寻找那些对他们打开relay功能的邮件主机。他们可能自己写了某个程序正每刻地进行扫描，如果你的邮件主机是易受攻击的，那么扫描到你就是迟早的事情。<br><strong>    三. Sendmail(8.9.3)如何relay你的邮件？    
</strong>      如果发送者和接收者都不属于本地域，sendmail将默认禁止mail relay. 要想使得sendmail relay<br>你的邮件，可以有下面两种途径，你必须确保发送者或者接收者其中至少有一个属于本地域.<br>a. 本地发送者到外部接收者(local sender to external recipient)    </p>
<h1 id="b-外部发送者到本地接收者-external-sender-to-local-recipient"><a href="#b-外部发送者到本地接收者-external-sender-to-local-recipient" class="headerlink" title="b. 外部发送者到本地接收者(external sender to local recipient)    "></a>b. 外部发送者到本地接收者(external sender to local recipient)    </h1><p>c. 何为本地发送者（local sender)?<br>当邮件服务器接收到一封从其它机器（如windows pc)发来的邮件时，它首先检查连接进来的主机的域名和 IP地址，注意：<br>决不是检查这封邮件的信封里的发送者地址（not based on the envelope MAIL FROM address!)<br>(要了解一封邮件的全部信封头信息，参考（<a href="http://www.stopspam.org/email/headers/headers.html）" target="_blank" rel="noopener">http://www.stopspam.org/email/headers/headers.html）</a>)<br>如果你是拨号用户，IP地址当然是你拨到ISP所得到的动态IP地址，然后你的主机名/域名是由你的ISP对你的IP<br>地址作反向DNS解析出来的主机名/域名，<br>不过大多数ISP不作这个，因此，sendmail将仅仅记录你连接进来的IP地址，由此判断是否这个地址被允许relay mail.对sendmail<br>8.9.3来说，最通常的用来检查是否relay邮件的配置文件是/etc/mail/relay-domains,它能对IP地址或域名进行判断是否允许relay.<br>如果这一步不允许，再检查/etc/mail/access（它能被通过加FEATURE(access_db)到.mc文件再用m4生成/etc/sendmail.cf所激活<br>附:本文讨论的所有设置都是基于M4宏命令生成的/etc/sendmail.cf）<br>d. 何为本地接收者（local recipient ）？<br>决定接收者邮件地址是否为本地的不是件轻松的事情，sendmail认为类w中的所有主机/域为本地接收者，也就是/etc/mail/sendmail.cw文件或者/etc/sendmail.cf中的Cw类定义后面列出的所有主机或域名。为了激活对/etc/mail/sendmail.cw的检查,使用特性Feature(use_cw_file)。但是这还不够，因为这个能被愚弄的，如.<br>因此sendmail用规则集(ruleset)先移走这个地址的本地部分(<br>@local.site)后，如果仍有一些域，则考虑是否能通过relay检查，另外，sendmail也还检查/etc/mail/access<br>决定是否有项目匹配接收者地址所在的域，根据相应标记确定是否被允许接收。 </p>
<p><strong>四. Sendmail 8.9.3: anti-relaying（拒绝传递）怎么工作？   
</strong>a. 如果Mail From:行有下面的参数，sendmail拒绝mail relay:<br>1.发送者的域名不能被解析。这个能用FEATURE(accept_unresolvable_domains)被禁止。<br>2.非全称的域名。能被用FEATURE(accept_unresolvable_domains)禁止。<br>3.与access map（ /etc/mail/access）中的一项匹配。<br>域名：如spammer.domain  reject<br>全称email地址：如spammer@domain reject<br>邮件地址的用户名部分：如spammer@  reject<br>或者不用’reject’用’error code error text’<br>spammer.domain “501 No e-mail from this domain.”<br>spammer@domain “501 No e-mail from your address.”<br>spammer@ “501 Get a real address.”<br>甚至用DISCARD （接收并安静地删除掉，让发送者感觉象被接收）<br>b.检查接收者。<br>用FEATURE(blacklist_recipients)允许指定access map中不应该接收email的用户。<br>如：<br>badlocaluser 550 Mailbox disabled for this username<br>host.mydomain 550 That host does not accept mail<br><a href="mailto:user@otherhost.mydomain" target="_blank" rel="noopener">user@otherhost.mydomain</a> 550 Mailbox disabled for this recipient<br>这将禁止发到你本地域中的用户邮件地址badlocaluse@mydomain和在主机<br>host.mydomain中的任何用户和单个地址 <a href="mailto:user@otherhost.mydomain" target="_blank" rel="noopener">user@otherhost.mydomain</a>.<br>注：关于access map的说明：<br>它的默认位置是/etc/mail/access. 每次更新后你必须运行<br>makemap hash /etc/mail/access.db &lt; /etc/mail/access ，不需要重启用Sendmail.<br>它可以有以下入口：<br>1.域名<br>2.email地址<br>3.本地用户名部分<br>4.IP地址（完整的或者子网）<br>和以下操作标记：<br>1.OK<br>接收email，即使被其它规则拒绝了<br>2.RELAY<br>允许通过该邮件主机relay的域。relay意味着OK<br>3.REJECT<br>拒绝email并显示内部通用的错误提示<br>4.DISCARD<br>安静地接收随后取消掉这封邮件<br>5.XYZ some other text<br>XYZ是 RFC 821兼容的错误代码后面跟上一段自定义的错误信息<br><strong>五.常见的两种检查规则   
</strong>  </p>
<ol>
<li>check_relay 规则（发送者检查）：<br>检查主机名和IP地址，当无论什么时候，一台客户通过(E)SMTP连到邮件服务器时该规则被调用。     </li>
<li>check_rcpt 规则（接收者检查）：<br>用于RCPT命令(用来禁止未被授权的relay).该规则禁止了所有的已知的relay诡计。<br>你能#tail -f /var/log/maillog检查是否某个邮件被运用了上述规则。 <strong>**六. Why “550 Relaying Denied”?    
</strong><br>如果你从你自己的邮件服务器得到了一个错误说”550 Relaying Denied”，你需要弄清楚为什么，甚至可能你认为这决不应该发生，但是你可能忽略了某些细节，看上去是应该被Relay，但实际上不。看下面的几个例子：<br>1.正确的DNS数据<br>QAA02454: … we do not relay<br>QAA02454: ruleset=check_rcpt, arg1=,<br>relay=170-51-209.ipt.aol.com [152.170.51.209], reject=550<br>… we do not relay<br>QAA02454: from=, size=0, class=0, pri=0, nrcpts=0,<br>proto=SMTP, relay=170-51-209.ipt.aol.com [152.170.51.209]<br>这里，主机名为170-51-209.ipt.aol.com的机器IP地址为152.170.51.209 试着交付一封邮件给，然而，这个被拒绝了，因为接收者不是本地接收者并且发送者的机器170-51-209.ipt.aol.com（152.170.51.209）也不是本地发送者。<br>2.错误的DNS数据<br>QAA02454: … Relaying denied<br>QAA02454: ruleset=check_rcpt, arg1=, relay=[134.245.85.93],<br>reject=550 … Relaying denied<br>QAA02454: from=, size=0, class=0, pri=0, nrcpts=0,<br>proto=SMTP, relay=[134.245.85.93]<br>这个其实与上面的情况相同，对于IP地址134.245.85.93没有PTR记录被找到，关于这一点有个问题就是：万一你的邮件主机的relay功能仅仅是基于主机/域名进行检查是否为本地发送者，(e.g., FEATURE(relay_entire_domain)，那样的话，如果该IP地址是属于你的本地域之内，仍将被你拒绝relay.解决办法是为这个IP地址加PTR记录，也就是反向DNS解析，或者添加到/etc/hosts文件中，再或者添加该IP地址到access map 中去（/etc/mail/access）。<br>3.不一致的DNS数据<br>QAA02454: … Relaying denied<br>QAA02454: ruleset=check_rcpt, arg1=,<br>relay=some.domain [10.0.0.1] (may be forged),<br>reject=550 … Relaying denied<br>QAA02454: from=, size=0, class=0, pri=0, nrcpts=0,<br>proto=SMTP, relay=some.domain [10.0.0.1] (may be forged)<br>这儿,(may be forged)是个很重要的部分：它说明对于该主机的DNS数据是不一致的，并且主机名不被用来检查是否被允许relay,而仅仅检查IP地址，因此这和第二种情况相同。<br><strong>七. 动态Relay授权控制简介：（DRAC）   
</strong><br>DRAC是一个后台程序，它动态地为Sendmail更新access map文件，它提供一种方法，就是允许合法的用户通过你的SMTP邮件主机relay mail,同时仍然阻止其它人用它作为Spam Relay.当用户被POP/IMAP服务器认证后其IP地址被立即加入/etc/mail/access允许mail relay.默认地，该IP地址在access map的入口在30分钟后被终止了。<br>这种功能特别是对那些公司有用，它们在各个地方有办事处，外地办事处或出差在外的笔记本用户通过拨入当地ISP，且设置了发送邮件服务器为本公司的SMTP邮件主机时。<br>一般地，Sendmail所能看见的唯一可靠的信息是客户机的主机/域名或IP地址，并且当一个用户是通过拨本地ISP连接到其本公司总部的SMTP邮件服务器时，Sendmail不能分辩你的用户是spammer还是本公司合法员工，如果拨号用户有固定的IP地址/域名，你可以配置sendmail允许他们relay mail.但是大多数情况，特别在中国，拨号用户每次得到的是不同的变化多端的IP地址，因此你不得不告诉用户通过他们本地ISP提供的邮件主机发送邮件.<br>DRAC所用的方法是叫做POP-before-SMTP, 既然POP服务器知道每一个接收邮件的客户机的IP地址,这些IP地址能被收集起来动态构建access map,你可能需要写一个程序来收集这些地址,象上面说的一样,默认保留30分钟然后取消这些IP地址的mail relay. 一般地定期运行makemap程序更新access map.<br>这有两种情况:   </li>
<li>拨到ISP后先收后发.   </li>
<li>在发件信(outbox)中有信,拨号后先发后收.<br>第一种情况没有问题,对于第二种情况,需要在连到POP3信箱收信之后邮件才能被发送,<br>第一次发送将被拒绝.<br>第二种情况在被POP3取得认证后，随即access map被更新允许SMTP Mail Relay.**</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/20/configure-sendmail/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/20/configure-sendmail/" itemprop="url">配置Sendmail</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-20T09:21:27+08:00">
                2011-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="要生成sendmail-cf文件"><a href="#要生成sendmail-cf文件" class="headerlink" title="要生成sendmail.cf文件"></a>要生成sendmail.cf文件</h2><p>一般是编译sendmail.mc来生成sendmail.cf,这样的好处是通过编译，会查看出一些sendmail的设置错误和漏洞。</p>
<p># cd /etc/mail # vi sendmail.mc </p>
<p>(1)找到：</p>
<p>TRUST_AUTH_MECH(`EXTERNAL DIGEST-MD5 CRAM-MD5 LOGIN PLAIN’)dnl </p>
<p>打开注解，启用相应的认证机制，主要是为了支持Outlook。</p>
<p>(2)找到：   </p>
<p>DAEMON_OPTIONS(<code>Port=25, Name=MSA,M=Ea&#39;)dnl 这样sendmail将在25端口进行强制身份认证  
dnl DAEMON_OPTIONS(</code>Port=smtp,Addr=0.0.0.0, Name=MTA’)dnl<br>dnl DAEMON_OPTIONS(`Port=587, Name=MSA,M=a’)dnl  </p>
<p>define(`confAUTH_MECHANISMS’, `EXTERNAL GSSAPI DIGEST-MD5 CRAM-MD5 LOGIN PLAIN’)dnl </p>
<p>打开注解，启用相应的认证机制，主要是为了支持Outlook。</p>
<p>(3)在(2)后添加两行：</p>
<p>设置MTA和MSA端口。</p>
<p>(4)找到：</p>
<p>dnl DAEMON_OPTIONS(`Port=smtp,Addr=127.0.0.1, Name=MTA’) </p>
<p>将该行注释掉，以允许通过网络连接Sendmail。</p>
<p>(5)找到：</p>
<p>dnl FEATURE(`accept_unresolvable_domains’) </p>
<p>禁止不可解析域名的转发邮件。</p>
<p>最后保存退出。</p>
<p>[<a href="http://kb.discuz.net/index.php?title=%E9%85%8D%E7%BD%AESendmail&amp;action=edit&amp;section=2" title="配置Sendmail" target="_blank" rel="noopener">编辑</a>]</p>
<h2 id="编译sendmail-mc生成sendmail-cf文件"><a href="#编译sendmail-mc生成sendmail-cf文件" class="headerlink" title="编译sendmail.mc生成sendmail.cf文件"></a>编译sendmail.mc生成sendmail.cf文件</h2><p># m4 /etc/mail/sendmail.mc &gt; /etc/mail/sendmail.cf # /etc/rc.d/init.d/sendmail restart –重起sendmail服务。 </p>
<p>如果在执行m4 /etc/mail/sendmail.mc &gt; /etc/mail/sendmail.cf 报错的话，那么检查是否安装sendmail-cf.*.rpm是否安装：</p>
<p># rpm -qa | grep sendmail-cf </p>
<p>如果没有安装，则需要在安装光盘中找到sendmail-cf包，并安装：</p>
<p># rpm -ivh sendmail-cf*.rpm </p>
<p>[<a href="http://kb.discuz.net/index.php?title=%E9%85%8D%E7%BD%AESendmail&amp;action=edit&amp;section=3" title="配置Sendmail" target="_blank" rel="noopener">编辑</a>]</p>
<h2 id="检测编译结果"><a href="#检测编译结果" class="headerlink" title="检测编译结果"></a>检测编译结果</h2><p>1、检测SASL被编译到sendmail中。</p>
<p>#/usr/sbin/sendmail -d0.1 -bv root |grep SASL </p>
<p>输出类似如下：</p>
<p>NETUNIX NEWDB NIS PIPELINING SASL SCANF STARTTLS TCPWRAPPERS </p>
<p>保证你看到SASL就是正确的。</p>
<p>2、检测25端口：</p>
<p># telnet localhost 25<br> Trying 127.0.0.1… Connected to localhost. Escape character is ‘^]’. 220 fyhtest.163.net ESMTP Sendmail 8.12.5/8.12.5; Thu, 10 Apr 2003 16:35:42 -0400 ehlo test 250-fyhtest.163.net Hello localhost [127.0.0.1], pleased to meet you 250-ENHANCEDSTATUSCODES 250-PIPELINING 250-8BITMIME 250-SIZE 250-DSN 250-ETRN 250-AUTH LOGIN PLAIN 250-DELIVERBY 250 HELP<br> quit —退出   </p>
<p>只要输出有LOGIN PLAIN就可以了。</p>
<p>到这里，sendmail就配置完了，你可以添加一个用户进行测试：</p>
<p>#useradd test #passwd test 设置密码 </p>
<p>把你服务器的域名添加到/etc/mail/local-host-names中。</p>
<p>[<a href="http://kb.discuz.net/index.php?title=%E9%85%8D%E7%BD%AESendmail&amp;action=edit&amp;section=4" title="配置Sendmail" target="_blank" rel="noopener">编辑</a>]</p>
<h2 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h2><p>要想更好的使用sendmail，常用到的一些设置：</p>
<p>1、限制最大邮件。</p>
<p># vi /etc/mail/sendmail.cf # maximum message size MaxMessageSize=5000000 (注：5M) </p>
<p>2、最大的群发数目。</p>
<p># vi /etc/mail/sendmail.cf # maximum number of recipients per SMTP envelope MaxRecipientsPerMessage=20 （注：20个） </p>
<p>3、域名文件—-local-host-name 可以用他来实现虚拟域名或多域名支持。</p>
<p># vi /etc/mail/local-host-name test.com test1.com </p>
<p>4、mail别名文件–aliases。</p>
<p># vi /etc/aliases 系统内部别名：discuz:bbsadmin discuz是我的用户名，其他的是别名，用逗号隔开。 转发到其他的邮箱：discuz:<a href="mailto:bbsadmin@discuz.com" target="_blank" rel="noopener">bbsadmin@discuz.com</a> # newaliases –写到库中 </p>
<p>5、邮件控制文件</p>
<p>relay、ok、reject和discard。</p>
<p>relay: 可以实现转发。</p>
<p>ok: 是用来允许用户的任意访问，它会覆盖任何其它已建立的检查（实际设置中，最好不要设为这项，除非你对该用户是绝对信任的）；</p>
<p>reject: 可以实现对来访地址的拒绝，它根本就不容许该地址与你的邮件服务器进行连接通信；</p>
<p>discard: 的作用是在接收到传输的邮件消息后，把它丢弃掉。在发送者看来，他的邮件的确是接收了，但他并不知道，发送的目的地址根本不可能接收到他的邮件，服务器巧妙地欺骗了他。</p>
<p># vi /etc/mail/<br>access<br> localhost.localdomain RELAY —允许 localhost RELAY 127.0.0.1 RELAY <a href="mailto:peng@sina.com" target="_blank" rel="noopener">peng@sina.com</a> ok @sexgirl.net reject 211.77.22.45 discard   </p>
<h1 id="makemap-hash-etc-mail-access-db-lt-etc-mail-access-–写到库中"><a href="#makemap-hash-etc-mail-access-db-lt-etc-mail-access-–写到库中" class="headerlink" title="makemap hash /etc/mail/access.db &lt; /etc/mail/access –写到库中"></a>makemap hash /etc/mail/access.db &lt; /etc/mail/access –写到库中</h1><p><strong>6、Sendmail环境下的防止邮件relay</strong><br>从8.9版本开始，缺省的是不允许邮件转发(mail relay)的。最简单的允许邮件转发的方法是在文件/etc/mail/relay-domains中进行设置。该文件中列出的域名内的信件都允许通过本地服务器进行邮件转发。<br>为了更精确的设置，可以在sendmail.mc中添加如下几个参数允许被用来设置邮件转发：<br>· FEATURE(relay_hosts_only). 通常情况下，在文件/etc/mail/relay-domains中列出的域名的主机都允许通过本地机转发，而该设置指示指定必须罗列出每个允许通过本机转发邮件的主机。<br>· FEATURE(relay_entire_domain). 该参数指示允许所有本地域通过本机进行邮件转发。<br>· FEATURE(access_db). 该参数指定利用哈希数据库/etc/mail/access来决定是否允许某个主机通过本地进行邮件转发。<br>· FEATURE(blacklist_recipients).若该参数被设置，则在决定是否允许某个主机转发邮件时同时察看邮件发送着地址和邮件接受者地址。<br>· FEATURE(rbl).允许基于maps.vix.com由黑名单(Realtime Blackhole List)进行邮件拒绝，以防范垃圾邮件。<br>· FEATURE(accept_unqualified_senders).允许接受发送者地址不包括域名的邮件，例如user，而不是<a href="mailto:user@B.NET" target="_blank" rel="noopener">user@B.NET</a>。<br>· FEATURE(accept_unresolvable_domains).通常来讲，sendmail拒绝接受发送者邮件地址指定的主机通过DNS不能解析的邮件，而该参数允许接收这种邮件。<br>· FEATURE(relay_based_on_MX).该参数允许转发邮件接受者地址的MX记录指向本地的的邮件，例如，本地接收到一个发送目的地址为<a href="mailto:user@b.com" target="_blank" rel="noopener">user@b.com</a>的邮件，而b.com域名的MX记录指向了本地机器，则本地机器就允许转发该邮件。<br>下面几个特性可能会有安全漏洞，一般当邮件服务器位于防火墙后时才应该使用，因为这些参数可能导致你的系统易于被垃圾邮件发送者利用。    </p>
<p>·FEATURE(relay_local_from).该参数指定若消息自称源于本地域，则允许转发该邮件。<br>             ·FEATURE(promiscuous_relay).打开对所有的邮件的转发。</p>
<p>7.设置完成后outlook发送邮件要求验证时，出现错误  </p>
<p>Jan 30 14:45:57 qiuding sendmail[13908]: o0U6jvs1013908: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:45:58 qiuding sendmail[13909]: o0U6jw4h013909: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:38 qiuding sendmail[13918]: o0U6lcCc013918: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:41 qiuding sendmail[13919]: o0U6lefW013919: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:42 qiuding sendmail[13920]: o0U6lfoF013920: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:43 qiuding sendmail[13921]: o0U6lgtZ013921: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:43 qiuding sendmail[13922]: o0U6lh53013922: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>Jan 30 14:47:44 qiuding sendmail[13923]: o0U6li7I013923: [116.230.242.136] did not issue MAIL/EXPN/VRFY/ETRN during connection to MTA<br>大量查找资料原来是<br>认证进程没有启动  SASLAUTHD服务一定要启动否则无法进行用户验证<br>etc/rc.d/init.d/saslauthd start<br><a href="http://www.blogjava.net/Files/lyjjq/sendmail_dovecot.rar" target="_blank" rel="noopener">配置下载</a>  </p>
<p>sendmail -bd -q1h  </p>
<p>　　Sendmail的命令参数的含义如下：  </p>
<p>　　-b：指定Sendmail在后台运行，并且监听端口25的请求。  </p>
<p>　　-d：指定Sendmail以Daemon方式运行(守护进程)。  </p>
<p>　　-q：当Sendmail无法将邮件成功地发送到目的地时，它会将邮件保存在队列里。该参数指定邮件在队列里保存的时间。例子里的1h表示保留1小时。  </p>
<p>　　在终端命令窗口运行以下命令来重新启动Sendmail服务：  </p>
<p>　　[root@ahpeng root]#/etc/rc.d/init.d/sendmail restart  </p>
<p>　　在终端命令窗口运行以下命令来关闭Sendmail服务：  </p>
<p>　　[root@ahpeng root]#/etc/rc.d/init.d/sendmail stop  </p>
<p>　　我们还可以在终端命令窗口运行以下命令来检测Sendmail服务器的运行状态：  </p>
<p>　　[root@ahpeng root]# /etc/rc.d/init.d/sendmail status  </p>
<p>　　系统应该显示：  </p>
<p>　　sendmail (pid 3251) 正在运行…  </p>
<p>/etc/mail目录下操作<br>makemap hash access.db&lt;access<br>killall -9 sendmail<br>etc/rc.d/init.d/saslauthd start<br>sendmail -bd -q30m</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/20/manage-mail-queues-for-sendmail/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/20/manage-mail-queues-for-sendmail/" itemprop="url">管理 sendmail 的邮件队列</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-20T09:17:00+08:00">
                2011-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>邮件队列是存储 sendmail 命令传送的邮件消息数据和控制文件的目录。缺省情况下，邮件队列是 /var/spool/mqueue。</p>
<p>邮件消息可能由于很多原因而排入队列。</p>
<p>例如：</p>
<ol>
<li>sendmail 命令可以配置成按一定的时间间隔处理队列，而不是立即处理。如果这样，邮件消息必须临时存储。</li>
<li>如果一个远程主机不响应一个邮件连接的请求，邮件系统会将这些消息排入队列，稍后再作尝试。</li>
</ol>
<h3 id="打印邮件队列"><a href="#打印邮件队列" class="headerlink" title="打印邮件队列"></a>打印邮件队列</h3><p>队列内容可以使用 mailq 命令打印（或通过指定 sendmail 命令的 -bp 标志）。</p>
<p>这些命令产生队列标识、消息大小、消息进入队列的日期以及发送方与收件人的列表。</p>
<h3 id="邮件队列文件"><a href="#邮件队列文件" class="headerlink" title="邮件队列文件"></a>邮件队列文件</h3><p>队列中的每条消息都与一定数量的文件相关联。这些文件按以下约定命名：</p>
<p>TypefID</p>
<p>其中 ID 是一个唯一的消息队列标识，而 Type 是以下表示文件类型的字母中的一个：</p>
<p>d</p>
<p>包含消息正文但无标题信息的数据文件。</p>
<p>q</p>
<p>队列控制文件。该文件包含处理作业所需要的信息。</p>
<p>t</p>
<p>临时文件。该文件是 q 文件重建时的一个映象。它快速重命名为 q 文件。</p>
<p>x</p>
<p>在会话过程中存在并显示该次会话中发生的任何事件的记录文件。</p>
<p>例如，如果一条消息的队列标识为 AA00269，当 sendmail 命令尝试传送消息时，在邮件队列目录中创建和删除以下文件：</p>
<p>dfAA00269</p>
<p>数据文件</p>
<p>qfAA00269</p>
<p>控制文件</p>
<p>tfAA00269</p>
<p>临时文件</p>
<p>xfAA00269</p>
<p>记录文件</p>
<h4 id="q-控制文件"><a href="#q-控制文件" class="headerlink" title="q 控制文件"></a>q 控制文件</h4><p>q 控制文件包括一系列行，每一行都以一个代码字母开始：</p>
<p>B</p>
<p>指定 body type。该行其余部分是定义 body type 的文本字符串。如果缺失该项字段，则缺省情况下 body type 是 7 位的，而且不会尝试特殊的处理。合法值是 7BIT 和 8BITMIME。</p>
<p>C</p>
<p>包括控制用户。对于以文件或程序作收件人的地址，sendmail 作为该文件或程序的所有者来执行传送。控制用户被设置为文件或程序的所有者。由 .forward 或 :include: 文件读取的收件人地址也将使控制用户被设置为文件所有者。当 sendmail 传送邮件到这些收件人时，sendmail 作为控制用户传送，然后转换回 root 用户。</p>
<p>F</p>
<p>包括信包标志。标志是以下的任意组合：w（设置 EF_WARNING 标志）、r（设置 EF_RESPONSE 标志）、8（设置 EF_HAS8BIT 标志）和 b（设置 EF_DELETE_BCC 标志）。其它字母则被忽略而无提示。</p>
<p>H</p>
<p>包括一个标题定义。此类行的数量任意。H 行出现的顺序确定了它们在最终消息里的出现顺序。这些行使用的语法与 /etc/mail/sendmail.cf 配置文件中的标题定义相同。（对于早于 AIX 5.1 的版本，该文件是 /etc/sendmail.cf。）</p>
<p>I</p>
<p>为 df 文件指定内节点和设备信息；这可以在磁盘崩溃后用来恢复邮件队列。</p>
<p>K</p>
<p>指定上一次传输尝试的时间（以秒为单位）。</p>
<p>&lt; span&gt;M</p>
<p>当一条消息由于在传送尝试中出现了错误而放入队列时，错误的性质就存储在 M 行。</p>
<p>N</p>
<p>指定传送尝试的总数。</p>
<p>O</p>
<p>指定 ESMTP 的消息传输系统（MTS）的原始值。它只用于传送状态通知。</p>
<p>P</p>
<p>包括当前消息的优先级。优先级用来对队列排序。数字越大表示优先级越低。当消息位于队列中时优先级增加。初始优先级取决于消息的类和消息的大小。</p>
<p>Q</p>
<p>包含初始收件人，由 ESMTP 事务中的 ORCPT= 字段指定。仅用于传送状态通知。只应用于紧接着的 R 行。</p>
<p>R</p>
<p>包含收件人地址。每个收件人占一行。</p>
<p>S</p>
<p>包含发送方地址。此类行只有一行。</p>
<p>T</p>
<p>包含消息创建时间，用来计算何时消息超时。</p>
<p>V</p>
<p>指定队列文件格式版本号（该队列文件格式用来允许新的 sendmail 二进制文件读取旧版本创建的队列文件）。缺省时指版本 0。如果存在，必须是文件的第一行。</p>
<p>Z</p>
<p>指定原始信包标识（从 ESMTP 事务中）。只用于传送状态通知。</p>
<p>$</p>
<p>包含宏定义。某些宏（$r 和 $s）的值会传递到队列运行阶段。</p>
<p>传送到 amy@zeus 的消息的 q 文件类似于：</p>
<p>P217031 T566755281 MDeferred: Connection timed out during user open with zeus Ramy@zeus H?P?return-path: <geo> Hreceived: by george (0.13 (NL support)/0.01) id AA00269; Thu, 17 Dec 87 10:01:21 CST H?D?date: Thu, 17 Dec 87 10:01:21 CST H?F?From: geo Hmessage-id: &lt;8712171601.AA00269@george&gt; HTo: amy@zeus Hsubject: test</geo></p>
<p>其中：</p>
<p>P217031</p>
<p>消息的优先级</p>
<p>T566755281</p>
<p>提交时间（秒）</p>
<p>MDeferred: Connection timed out during user open with zeus</p>
<p>状态消息</p>
<p>Sgeo</p>
<p>发送方标识</p>
<p>Ramy@zeus</p>
<p>收件人标识</p>
<p>Hlines</p>
<p>消息的报头信息</p>
<h3 id="在-sendmail-中指定时间值"><a href="#在-sendmail-中指定时间值" class="headerlink" title="在 sendmail 中指定时间值"></a>在 sendmail 中指定时间值</h3><p>要设置消息超时和队列处理间隔，必须用特定的时间值格式。时间值的格式是：</p>
<p>-qNumberUnit</p>
<p>其中 Number 是一个整数值，Unit 是单位字母。Unit 可以是以下值中的一个：</p>
<p>s</p>
<p>秒</p>
<p>m</p>
<p>分</p>
<p>h</p>
<p>小时</p>
<p>d</p>
<p>天</p>
<p>w</p>
<p>周</p>
<p>如果没有指定 Unit，sendmail 守护程序使用分（m）作为缺省值。下面三个示例说明时间值的规范：</p>
<p>/usr/sbin/sendmail -q15d</p>
<p>该命令使得 sendmail 守护程序每 15 天处理一次队列。</p>
<p>/usr/sbin/sendmail -q15h</p>
<p>该命令使得 sendmail 守护程序每 15 小时处理一次队列。</p>
<p>/usr/sbin/sendmail -q15</p>
<p>该命令使得 sendmail 守护程序每 15 分钟处理一次队列。</p>
<h3 id="强制邮件队列"><a href="#强制邮件队列" class="headerlink" title="强制邮件队列"></a>强制邮件队列</h3><p>在某些情况下，您可能发现队列由于某种原因阻塞。您可以使用 -q 标志（没有值）强制一个队列运行。您也可以用 -v 标志（详细）来观察发生了什么：</p>
<p>/usr/sbin/sendmail -q -v</p>
<p>使用一个队列修饰符，您也可以将作业限制在具有特定队列标识符、发送方或收件人的范围中。例如，-qRsally 将队列运行限制为收件人地址之一中有字符串 sally 的作业。同样，-qS 字符串会将运行限制为特定的发送方，而 -qI 字符串将它限制为特定的队列标识。</p>
<h3 id="设置队列处理时间间隔"><a href="#设置队列处理时间间隔" class="headerlink" title="设置队列处理时间间隔"></a>设置队列处理时间间隔</h3><p>守护程序启动时 -q 标志的值确定 sendmail 守护程序处理邮件队列的时间间隔。</p>
<p>sendmail 守护程序通常由 /etc/rc.tcpip 文件在系统启动时启动。/etc/rc.tcpip 文件包含一个称为队列处理间隔（QPI）的变量，该变量在该文件启动 sendmail 守护程序时用来指定 -q 标志的值。缺省情况下，qpi 的值是 30 分钟。要指定不同的队列处理间隔：</p>
<ol>
<li>用您喜欢的编辑器编辑 /etc/rc.tcpip 文件。</li>
<li><p>查找给 qpi 变量指定值的行，例如：</p>
<p>qpi=30m</p>
</li>
<li><p>将指定给变量 qpi 的值更改为希望的时间值。</p>
</li>
</ol>
<p>这些变化会在下一次系统重新启动时生效。如果您想让这些变化立刻生效，请停止并重新启动 sendmail 守护程序，指定新的 -q 标志值。更多相关信息，请参阅<a href="http://publib16.boulder.ibm.com/pseries/zh_CN/aixbman/commadmn/ml_queue.htm#a2a5b399043joyc" target="_blank" rel="noopener">停止 sendmail 守护程序</a>和<a href="http://publib16.boulder.ibm.com/pseries/zh_CN/aixbman/commadmn/ml_queue.htm#c15fd1b790atla" target="_blank" rel="noopener">启动 sendmail 守护程序</a>。</p>
<h3 id="移动邮件队列"><a href="#移动邮件队列" class="headerlink" title="移动邮件队列"></a>移动邮件队列</h3><p>当一个主机长期关闭时，路由到（或通过）该主机的很多消息可能存储在邮件队列中。结果 sendmail 命令要花费很长时间对队列排序，这严重降低了系统性能。如果您移动队列到一个临时空间并创建一个新的队列，旧队列可以稍后在该主机恢复服务后运行。要移动队列到一个临时空间并创建一个新的队列，请：</p>
<ol>
<li>按<a href="http://publib16.boulder.ibm.com/pseries/zh_CN/aixbman/commadmn/ml_queue.htm#a2a5b399043joyc" target="_blank" rel="noopener">停止 sendmail 守护程序</a>中的指示信息停止 sendmail 守护程序。</li>
<li><p>输入以下内容移动整个队列目录：</p>
<p>cd /var/spool     mv mqueue omqueue</p>
</li>
<li><p>按<a href="http://publib16.boulder.ibm.com/pseries/zh_CN/aixbman/commadmn/ml_queue.htm#c15fd1b790atla" target="_blank" rel="noopener">启动 sendmail 守护程序</a>中的指示信息重新启动 sendmail 守护程序。</p>
</li>
<li><p>输入以下内容处理旧邮件队列：</p>
<p>/usr/sbin/sendmail -oQ/var/spool/omqueue -q</p>
<p>-oQ 标志指定一个备用队列目录。 -q 标志指定运行队列中的每一项作业。要获取操作过程的报告，请使用 -v 标志。</p>
<p>注:</p>
<p>此操作可能要花些时间。</p>
</li>
<li><p>当队列为空时，输入以下内容除去日志文件和临时目录：</p>
<p>rm /var/spool/omqueue/*     rmdir /var/spool/omqueue</p>
</li>
</ol>
<h3 id="启动-sendmail-守护程序"><a href="#启动-sendmail-守护程序" class="headerlink" title="启动 sendmail 守护程序"></a>启动 sendmail 守护程序</h3><p>要启动 sendmail 守护程序，请输入以下命令中的一个：</p>
<p>startsrc -s sendmail -a “-bd -q15”</p>
<p>/usr/lib/sendmail -bd -q15</p>
<p>如果 sendmail 守护程序在输入这些命令中的一个时已经激活，请参阅屏幕上的以下消息：</p>
<p>sendmail 子系统已经激活。不支持多实例。</p>
<p>如果 sendmail 守护程序没有被激活，您将会看到一条消息表示 0sendmail 守护程序已经启动。</p>
<h3 id="停止-sendmail-守护程序"><a href="#停止-sendmail-守护程序" class="headerlink" title="停止 sendmail 守护程序"></a>停止 sendmail 守护程序</h3><p>要停止 sendmail 守护程序，请运行 stopsrc -s sendmail 命令。</p>
<p>如果 sendmail 守护程序没有随 startsrc 命令启动，请：</p>
<ul>
<li>查找 sendmail 进程标识。</li>
<li>输入 kill sendmail_pid 命令。（其中 sendmail_pid 是 sendmail 过程的处理标识）。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/19/zeroconf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/19/zeroconf/" itemprop="url">zeroconf</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-19T17:41:09+08:00">
                2011-09-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/默认分类/" itemprop="url" rel="index">
                    <span itemprop="name">默认分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>avahi-daemon, avahi-dnsconfd<br>Avahi 是 zeroconf 协议的实现。它可以在没有 DNS 服务的局域网里发现基于 zeroconf 协议的设备和服务。它跟 mDNS 一样。除非你有兼容的设备或使用 zeroconf 协议的服务，否则应该关闭它。我把它关闭。<br>可以在配置文件里关闭它<strong>NOZEROCONF</strong>=yes</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2011/09/08/linux-problem-last-message-to-the-n-times/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="haitian">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="haitian的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2011/09/08/linux-problem-last-message-to-the-n-times/" itemprop="url">Linux问题：last message repeated N times</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2011-09-08T09:48:26+08:00">
                2011-09-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>偶然发现系统日志/var/log/messages里出现大量错误信息：  </p>
<p>Jun 8 13:20:49 SERVER snmpd[14281]: Connection from UDP: [192.168.0.178]:9632<br>Jun 8 13:25:07 SERVER last message repeated 7 times<br>Jun 8 13:30:49 SERVER last message repeated 8 times  </p>
<p>先来想办法重现一下这个问题，在shell里使用logger命令：  </p>
<p>logger “foo”<br>logger “foo”<br>logger “foo”<br>logger “bar”  </p>
<p>logger命令会向/var/log/messages日志里写入相应的信息，可以用tail -f /var/log/messages查看：  </p>
<p>Jun 8 21:23:32 SERVER root: foo<br>Jun 8 21:23:34 SERVER last message repeated 2 times<br>Jun 8 21:23:37 SERVER root: bar  </p>
<p>大致了解了last message repeated N times信息产生的原因。至于它的作用，无非是为了屏蔽不必要的重复信息，感觉用处不大，看着还闹心。真实的重复信息也就是last message repeated N times上面的信息，如此一来，回到文章开头，就能猜到本文中出现大量last message repeated N times的原因在于有一个IP不断的连接snmpd服务，且中间没有插入其他日志信息。  </p>
<p>查看一下snmpd的启动脚本/etc/init.d/snmpd，会发现里面有如下参数设置：  </p>
<p>OPTIONS=”-Lsd -Lf /dev/null -p /var/run/snmpd.pid -a”  </p>
<p>通过man snmpd和man snmpcmd查到-Lsd参数的作用就是向syslog里系日志，没什么大用，直接去掉：  </p>
<p>OPTIONS=”-Lf /dev/null -p /var/run/snmpd.pid -a”  </p>
<p>修改后别忘了重启一下服务：/etc/init.d/snmpd restart，唐僧不再唠叨，世界终于清净了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="http://q1.qlogo.cn/g?b=qq&nk=493654134&s=5"
                alt="haitian" />
            
              <p class="site-author-name" itemprop="name">haitian</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">278</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">164</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">haitian</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
